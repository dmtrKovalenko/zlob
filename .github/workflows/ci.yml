name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  ZIG_VERSION: "0.15.1"

jobs:
  linux:
    name: Linux
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      # Format checks
      - name: Check Zig format
        run: zig fmt --check src/ test/ bench/

      - name: Check Rust format
        working-directory: rust
        run: cargo fmt --check

      - name: Rust clippy
        working-directory: rust
        run: cargo clippy -- -D warnings

      - name: Zig build
        run: zig build

      - name: Zig tests
        run: zig build test

      - name: Rust tests
        working-directory: rust
        run: cargo test

      - name: Rust build release
        working-directory: rust
        run: cargo build --release

      - name: Make build
        run: make

      - name: Make test
        run: make test

  cross-compile:
    name: Cross-compile (Linux -> macOS ${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-macos
            rust_target: x86_64-apple-darwin
            artifact: zlob-macos-x86_64
          - target: aarch64-macos
            rust_target: aarch64-apple-darwin
            artifact: zlob-macos-aarch64

    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Install cargo-zigbuild
        run: cargo install cargo-zigbuild

      - name: Cross-compile Zig CLI
        run: zig build -Dtarget=${{ matrix.target }} -Doptimize=ReleaseFast

      - name: Cross-compile Rust library
        working-directory: rust
        run: cargo zigbuild --target ${{ matrix.rust_target }} --release

      - name: Package artifacts
        run: |
          mkdir -p dist
          cp zig-out/bin/zlob dist/ || true
          cp zig-out/lib/libzlob.a dist/ || true
          cp zig-out/lib/libzlob.dylib dist/ || true
          cp rust/target/${{ matrix.rust_target }}/release/libzlob.rlib dist/ || true
          tar -czvf ${{ matrix.artifact }}.tar.gz -C dist .

      - name: Upload cross-compiled artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.tar.gz
          retention-days: 1

  macos-test-cross:
    name: macOS test cross-compiled (${{ matrix.arch }})
    needs: cross-compile
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            artifact: zlob-macos-x86_64
          - arch: aarch64
            artifact: zlob-macos-aarch64

    steps:
      - uses: actions/checkout@v4

      - name: Download cross-compiled artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}

      - name: Extract and test CLI
        run: |
          tar -xzvf ${{ matrix.artifact }}.tar.gz
          chmod +x zlob
          ./zlob --version
          ./zlob "*.zig" src/
          ./zlob "**/*.zig" src/
          ./zlob "*.{zig,zon}" .

      - name: Test static library
        run: |
          file libzlob.a
          ar -t libzlob.a

  macos-native:
    name: macOS native
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Zig build
        run: zig build

      - name: Zig tests
        run: zig build test

      - name: Test Zig CLI
        run: |
          ./zig-out/bin/zlob --version
          ./zig-out/bin/zlob "*.zig" src/
          ./zig-out/bin/zlob "**/*.zig" .

      - name: Rust tests
        working-directory: rust
        run: cargo test

      - name: Rust build release
        working-directory: rust
        run: cargo build --release
